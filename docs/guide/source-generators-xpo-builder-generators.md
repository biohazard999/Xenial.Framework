---
title: SourceGenerators - XpoBuilderGenerator
sidebarDepth: 5
demoName: Acme.XpoBuilderDemo
---

# XpoBuilderGenerator - Introduction

A generator that helps you using the builder pattern with XPO Objects when dealing with complicated object models and UnitTests.

## Intent

When writing XPO/XAF code we need to deal object creation all the time. Most of the time this is an easy task by using `ObjectSpace.CreateObject<T>()` or just creating the class manually by using the constructor `new MyBusinessObject(session)`. When the business model grows and the internals of the class structure we can use the [BuilderPattern](https://blog.xenial.io/2019/05/26/t-is-for-testing-xaf-xpo-test-data-2.html) to decouple the creation of (complex) objects from the actual domain logic and reduce possible bugs when requirements change over time. This may often result in a works here, but not here scenario. With the flexibility XAF provides, this can lead to hard to grasp bugs. Writing the builder code can be tedious and error prone. This source generator tries to minimize this weakness.

## Usage

```cs{5,19}
using DevExpress.Xpo;

namespace Acme.Module
{
    [Xenial.XenialXpoBuilder]
    public class Person : XPObject
    {
        public Person(Session session) : base(session) { }

        public string FirstName { get; set; }
        public string LastName { get; set; }

        public Person Manager { get; set; }

        [Association]
        public XPCollection<Task> Tasks => GetCollection<Task>(nameof(Tasks));
    }

    [Xenial.XenialXpoBuilder]
    public class Task : XPObject
    {
        public Task(Session session) : base(session) { }

        [Association]
        public Person Person { get; set; }
    
        public string Description { get; set; }
    
        public TimeSpan Duration { get; set; }
    }
}
```

## Generated-Code

```cs
// <auto-generated />

using System;
using System.Runtime.CompilerServices;

namespace Acme.Module.BusinessObjects
{
    [CompilerGenerated]
    internal partial class PersonBuilder : PersonBuilder<Acme.Module.BusinessObjects.Person, PersonBuilder> { }
    
    [CompilerGenerated]
    internal abstract partial class PersonBuilder<TClass, TBuilder>
        where TClass : Acme.Module.BusinessObjects.Person
        where TBuilder : PersonBuilder<TClass, TBuilder>
    {
        protected DevExpress.Xpo.Session Session { get; set; }
        protected bool WasSessionSet { get; private set; }
        
        public TBuilder WithSession(DevExpress.Xpo.Session session)
        {
            this.Session = session;
            this.WasSessionSet = true;
            return This;
        }
        
        protected DevExpress.ExpressApp.IObjectSpace ObjectSpace { get; set; }
        protected bool WasObjectSpaceSet { get; private set; }
        
        public TBuilder WithObjectSpace(DevExpress.ExpressApp.IObjectSpace objectSpace)
        {
            this.ObjectSpace = objectSpace;
            this.WasObjectSpaceSet = true;
            return This;
        }
        
        protected TBuilder This
        {
            get
            {
                return (TBuilder)this;
            }
        }
        
        protected virtual TClass CreateTarget()
        {
            if(this.WasObjectSpaceSet)
            {
                return this.ObjectSpace.CreateObject<TClass>();
            }
            
            if(this.WasSessionSet)
            {
                return (TClass)new Acme.Module.BusinessObjects.Person(this.Session);
            }
            
            throw new System.InvalidOperationException($"Could not create instance of type [Acme.Module.BusinessObjects.Person] without a Session or ObjectSpace.{System.Environment.NewLine}Make sure to use the [WithSession] or [WithObjectSpace] methods when using the [{this.GetType().FullName}] type.");
        }
        
        protected string FirstName { get; set; }
        protected bool WasFirstNameCalled { get; private set; }
        
        public TBuilder WithFirstName(string firstName)
        {
            this.FirstName = firstName;
            this.WasFirstNameCalled = true;
            return This;
        }
        
        protected string LastName { get; set; }
        protected bool WasLastNameCalled { get; private set; }
        
        public TBuilder WithLastName(string lastName)
        {
            this.LastName = lastName;
            this.WasLastNameCalled = true;
            return This;
        }
        
        protected Acme.Module.BusinessObjects.Person Manager { get; set; }
        protected bool WasManagerCalled { get; private set; }
        
        public TBuilder WithManager(Acme.Module.BusinessObjects.Person manager)
        {
            this.Manager = manager;
            this.WasManagerCalled = true;
            return This;
        }
        
        protected Acme.Module.BusinessObjects.PersonBuilder ManagerBuilder { get; set; }
        protected bool WasManagerBuilderCalled { get; private set; }
        
        public TBuilder WithManager(Action<Acme.Module.BusinessObjects.PersonBuilder> managerBuilder)
        {
            if(managerBuilder != null)
            {
                Acme.Module.BusinessObjects.PersonBuilder builder = new Acme.Module.BusinessObjects.PersonBuilder();
                this.WithManager(builder);
                managerBuilder.Invoke(builder);
            }
            return This;
        }
        
        public TBuilder WithManager(Acme.Module.BusinessObjects.PersonBuilder managerBuilder)
        {
            this.ManagerBuilder = managerBuilder;
            this.WasManagerBuilderCalled = true;
            if(this.WasSessionSet)
            {
                this.ManagerBuilder.WithSession(this.Session);
            }
            if(this.WasObjectSpaceSet)
            {
                this.ManagerBuilder.WithObjectSpace(this.ObjectSpace);
            }
            return This;
        }
        
        private System.Collections.Generic.IList<Acme.Module.BusinessObjects.TaskBuilder> _TasksBuildersCollection = new System.Collections.Generic.List<Acme.Module.BusinessObjects.TaskBuilder>();
        protected System.Collections.Generic.IList<Acme.Module.BusinessObjects.TaskBuilder> TasksBuildersCollection { get { return _TasksBuildersCollection; } }
        
        public TBuilder WithTasks(Action<Acme.Module.BusinessObjects.TaskBuilder> tasksBuilder)
        {
            if(tasksBuilder != null)
            {
                Acme.Module.BusinessObjects.TaskBuilder builder = new Acme.Module.BusinessObjects.TaskBuilder();
                this.WithTasks(builder);
                tasksBuilder.Invoke(builder);
            }
            return This;
        }
        
        public TBuilder WithTasks(Acme.Module.BusinessObjects.TaskBuilder tasks)
        {
            if(this.WasSessionSet)
            {
                tasks.WithSession(this.Session);
            }
            if(this.WasObjectSpaceSet)
            {
                tasks.WithObjectSpace(this.ObjectSpace);
            }
            this.TasksBuildersCollection.Add(tasks);
            return This;
        }
        
        private System.Collections.Generic.IList<Acme.Module.BusinessObjects.Task> _TasksCollection = new System.Collections.Generic.List<Acme.Module.BusinessObjects.Task>();
        protected System.Collections.Generic.IList<Acme.Module.BusinessObjects.Task> TasksCollection { get { return _TasksCollection; } }
        
        public TBuilder WithTasks(Acme.Module.BusinessObjects.Task tasks)
        {
            this.TasksCollection.Add(tasks);
            return This;
        }
        
        public virtual TClass Build()
        {
            TClass target = this.CreateTarget();
            
            if(this.WasFirstNameCalled)
            {
                target.FirstName = this.FirstName;
            }
            
            if(this.WasLastNameCalled)
            {
                target.LastName = this.LastName;
            }
            
            if(this.WasManagerBuilderCalled)
            {
                this.WithManager(this.ManagerBuilder.Build());
            }
            
            if(this.WasManagerCalled)
            {
                target.Manager = this.Manager;
            }
            
            foreach(Acme.Module.BusinessObjects.TaskBuilder item in this.TasksBuildersCollection)
            {
                this.WithTasks(item.Build());
            }
            
            foreach(Acme.Module.BusinessObjects.Task item in this.TasksCollection)
            {
                target.Tasks.Add(item);
            }
            
            return target;
        }
    }

    [CompilerGenerated]
    internal partial class TaskBuilder : TaskBuilder<Acme.Module.BusinessObjects.Task, TaskBuilder> { }
    
    [CompilerGenerated]
    internal abstract partial class TaskBuilder<TClass, TBuilder>
        where TClass : Acme.Module.BusinessObjects.Task
        where TBuilder : TaskBuilder<TClass, TBuilder>
    {
        protected DevExpress.Xpo.Session Session { get; set; }
        protected bool WasSessionSet { get; private set; }
        
        public TBuilder WithSession(DevExpress.Xpo.Session session)
        {
            this.Session = session;
            this.WasSessionSet = true;
            return This;
        }
        
        protected DevExpress.ExpressApp.IObjectSpace ObjectSpace { get; set; }
        protected bool WasObjectSpaceSet { get; private set; }
        
        public TBuilder WithObjectSpace(DevExpress.ExpressApp.IObjectSpace objectSpace)
        {
            this.ObjectSpace = objectSpace;
            this.WasObjectSpaceSet = true;
            return This;
        }
        
        protected TBuilder This
        {
            get
            {
                return (TBuilder)this;
            }
        }
        
        protected virtual TClass CreateTarget()
        {
            if(this.WasObjectSpaceSet)
            {
                return this.ObjectSpace.CreateObject<TClass>();
            }
            
            if(this.WasSessionSet)
            {
                return (TClass)new Acme.Module.BusinessObjects.Task(this.Session);
            }
            
            throw new System.InvalidOperationException($"Could not create instance of type [Acme.Module.BusinessObjects.Task] without a Session or ObjectSpace.{System.Environment.NewLine}Make sure to use the [WithSession] or [WithObjectSpace] methods when using the [{this.GetType().FullName}] type.");
        }
        
        protected Acme.Module.BusinessObjects.Person Person { get; set; }
        protected bool WasPersonCalled { get; private set; }
        
        public TBuilder WithPerson(Acme.Module.BusinessObjects.Person person)
        {
            this.Person = person;
            this.WasPersonCalled = true;
            return This;
        }
        
        protected Acme.Module.BusinessObjects.PersonBuilder PersonBuilder { get; set; }
        protected bool WasPersonBuilderCalled { get; private set; }
        
        public TBuilder WithPerson(Action<Acme.Module.BusinessObjects.PersonBuilder> personBuilder)
        {
            if(personBuilder != null)
            {
                Acme.Module.BusinessObjects.PersonBuilder builder = new Acme.Module.BusinessObjects.PersonBuilder();
                this.WithPerson(builder);
                personBuilder.Invoke(builder);
            }
            return This;
        }
        
        public TBuilder WithPerson(Acme.Module.BusinessObjects.PersonBuilder personBuilder)
        {
            this.PersonBuilder = personBuilder;
            this.WasPersonBuilderCalled = true;
            if(this.WasSessionSet)
            {
                this.PersonBuilder.WithSession(this.Session);
            }
            if(this.WasObjectSpaceSet)
            {
                this.PersonBuilder.WithObjectSpace(this.ObjectSpace);
            }
            return This;
        }
        
        protected string Description { get; set; }
        protected bool WasDescriptionCalled { get; private set; }
        
        public TBuilder WithDescription(string description)
        {
            this.Description = description;
            this.WasDescriptionCalled = true;
            return This;
        }
        
        protected System.TimeSpan Duration { get; set; }
        protected bool WasDurationCalled { get; private set; }
        
        public TBuilder WithDuration(System.TimeSpan duration)
        {
            this.Duration = duration;
            this.WasDurationCalled = true;
            return This;
        }
        
        public virtual TClass Build()
        {
            TClass target = this.CreateTarget();
            
            if(this.WasPersonBuilderCalled)
            {
                this.WithPerson(this.PersonBuilder.Build());
            }
            
            if(this.WasPersonCalled)
            {
                target.Person = this.Person;
            }
            
            if(this.WasDescriptionCalled)
            {
                target.Description = this.Description;
            }
            
            if(this.WasDurationCalled)
            {
                target.Duration = this.Duration;
            }
            
            return target;
        }
    }
}


```

## Demo-Source

<!-- markdownlint-disable MD033 -->
You can find demo sources in the <a target="_blank" :href=" $var['gitHubUrl'] + '/tree/' + $var['gitBranch'] + '/demos/SourceGenerators/' + $frontmatter.demoName">Xenial.Framework repository</a> for in depth usage information.
<!-- markdownlint-enable MD033 -->

using System;
using System.Collections.Generic;
using System.Linq;

using DevExpress.ExpressApp.Model;
using DevExpress.ExpressApp.Model.Core;
using DevExpress.ExpressApp.Model.NodeGenerators;

using Xenial.Framework.Layouts;
using Xenial.Framework.Layouts.Items;
using Xenial.Framework.Layouts.Items.Base;

namespace Xenial.Framework.Model.GeneratorUpdaters
{
    /// <summary>
    /// Class ModelDetailViewLayoutNodesGeneratorUpdater.
    /// Implements the <see cref="DevExpress.ExpressApp.Model.ModelNodesGeneratorUpdater{DevExpress.ExpressApp.Model.NodeGenerators.ModelDetailViewLayoutNodesGenerator}" />
    /// </summary>
    /// <seealso cref="DevExpress.ExpressApp.Model.ModelNodesGeneratorUpdater{DevExpress.ExpressApp.Model.NodeGenerators.ModelDetailViewLayoutNodesGenerator}" />
    /// <autogeneratedoc />
    public class ModelDetailViewLayoutNodesGeneratorUpdater : ModelNodesGeneratorUpdater<ModelDetailViewLayoutNodesGenerator>
    {
        /// <summary>
        /// Updates the Application Model node content generated by the Nodes Generator, specified by the <see cref="T:DevExpress.ExpressApp.Model.ModelNodesGeneratorUpdater`1" /> class' type parameter.
        /// </summary>
        /// <param name="modelNode">A ModelNode Application Model node to be updated.</param>
        /// <exception cref="NotImplementedException"></exception>
        /// <autogeneratedoc />
#pragma warning disable CA1725 //match identitfier of base class -> would conflict with nodes
        public override void UpdateNode(ModelNode modelNode)
#pragma warning restore CA1725 //match identitfier of base class -> would conflict with nodes
        {
            if (modelNode is IModelViewLayout modelViewLayout)
            {
                if (modelViewLayout.Parent is IModelDetailView modelDetailView)
                {
                    //TODO: check IModelObjectGeneratedView

                    if (modelDetailView.Equals(modelDetailView.ModelClass.DefaultDetailView))
                    {
                        //TODO: multiple views and attributes
                        var attribute = modelDetailView.ModelClass.TypeInfo.FindAttribute<DetailViewLayoutBuilderAttribute>();
                        //TODO: Factory
                        if (attribute.BuildLayoutDelegate is not null)
                        {
                            var builder = attribute.BuildLayoutDelegate;
                            var layout = builder.Invoke()
                                ?? throw new InvalidOperationException($"LayoutBuilder on Type '{modelDetailView.ModelClass.TypeInfo.Type}' for View '{modelDetailView.Id}' must return an object of Type '{typeof(Layout)}'");

                            modelViewLayout.ClearNodes();

                            var modelMainNode = modelViewLayout
                                .AddNode<IModelLayoutGroup>(ModelDetailViewLayoutNodesGenerator.MainLayoutGroupName)
                                ?? throw new InvalidOperationException($"Cannot generate 'Main' node on Type '{modelDetailView.ModelClass.TypeInfo.Type}' for View '{modelDetailView.Id}'");

                            foreach (var layoutViewItemNode in VisitNodes<LayoutViewItem>(layout))
                            {
                                var modelLayoutViewItem = modelMainNode.AddNode<IModelLayoutViewItem>(layoutViewItemNode.Id);
                                modelLayoutViewItem.ViewItem = modelDetailView.Items.OfType<IModelViewItem>().FirstOrDefault(m => m.Id == layoutViewItemNode.ViewItemId);

                                if (modelLayoutViewItem is IModelNode genericModelNode)
                                {
                                    MapModelNode(genericModelNode, layoutViewItemNode);
                                }

                                if (modelLayoutViewItem is ISupportControlAlignment modelSupportControlAlignment)
                                {
                                    MapSupportControlAlignment(modelSupportControlAlignment, layoutViewItemNode);
                                }

                                if (modelLayoutViewItem is IModelToolTip modelToolTip)
                                {
                                    MapModelToolTip(modelToolTip, layoutViewItemNode);
                                }

                                if (modelLayoutViewItem is IModelToolTipOptions modelToolTipOptions)
                                {
                                    MapModelToolTipOptions(modelToolTipOptions, layoutViewItemNode);
                                }

                                if (modelLayoutViewItem is IModelLayoutItem modelLayoutItem)
                                {
                                    MapModelLayoutItem(modelLayoutItem, layoutViewItemNode);
                                }

                                if (modelLayoutViewItem is IModelLayoutElementWithCaptionOptions modelLayoutElementWithCaptionOptions)
                                {
                                    MapLayoutElementWithCaptionOptions(modelLayoutElementWithCaptionOptions, layoutViewItemNode);
                                }
                                else if (modelLayoutViewItem.ViewItem is IModelLayoutElementWithCaptionOptions modelLayoutElementWithCaptionOptions2)
                                {
                                    MapLayoutElementWithCaptionOptions(modelLayoutElementWithCaptionOptions2, layoutViewItemNode);
                                }

                                if (modelLayoutViewItem is IModelLayoutElementWithCaption modelLayoutElementWithCaption)
                                {
                                    MapCaption(modelLayoutElementWithCaption, layoutViewItemNode);
                                }
                                else if (modelLayoutViewItem.ViewItem is IModelLayoutElementWithCaption modelLayoutElementWithCaption2)
                                {
                                    MapCaption(modelLayoutElementWithCaption2, layoutViewItemNode);
                                }
                                else if (modelLayoutViewItem.ViewItem is not null)
                                {
                                    if (layoutViewItemNode.Caption is not null)
                                    {
                                        modelLayoutViewItem.ViewItem.Caption = layoutViewItemNode.Caption;
                                    }
                                }

                                if (layoutViewItemNode is LayoutPropertyEditorItem layoutPropertyEditorItem
                                    && layoutPropertyEditorItem.PropertyEditorOptions is not null)
                                {
                                    var modelViewItem = modelDetailView
                                        .Items[layoutPropertyEditorItem.PropertyEditorId];

                                    if (modelViewItem is IModelPropertyEditor modelPropertyEditor)
                                    {
                                        layoutPropertyEditorItem.PropertyEditorOptions(modelPropertyEditor);
                                    }
                                }
                            }
                        }
                    }
                    else
                    {

                    }
                }
            }

            static IEnumerable<TItem> VisitNodes<TItem>(LayoutItemNode node)
                where TItem : LayoutItemNode
            {
                if (node is TItem targetNode)
                {
                    yield return targetNode;
                }

                if (node is IEnumerable<LayoutItemNode> items)
                {
                    foreach (var item in items)
                    {
                        foreach (var nestedItem in VisitNodes<TItem>(item))
                        {
                            yield return nestedItem;
                        }
                    }
                }
            }

            static void MapCaption(
                IModelLayoutElementWithCaption modelLayoutElementWithCaption,
                LayoutViewItem layoutViewItemNode
            )
            {
                if (layoutViewItemNode.Caption is not null)
                {
                    modelLayoutElementWithCaption.Caption =
                        layoutViewItemNode.Caption ?? modelLayoutElementWithCaption.Caption;
                }
            }

            static void MapLayoutElementWithCaptionOptions(
                IModelLayoutElementWithCaptionOptions modelLayoutElementWithCaption,
                LayoutViewItem layoutViewItemNode
            )
            {
                if (layoutViewItemNode.ShowCaption is not null)
                {
                    modelLayoutElementWithCaption.ShowCaption =
                        layoutViewItemNode.ShowCaption ?? modelLayoutElementWithCaption.ShowCaption;
                }

                if (layoutViewItemNode.CaptionLocation is not null)
                {
                    modelLayoutElementWithCaption.CaptionLocation =
                        layoutViewItemNode.CaptionLocation ?? modelLayoutElementWithCaption.CaptionLocation;
                }

                if (layoutViewItemNode.CaptionHorizontalAlignment is not null)
                {
                    modelLayoutElementWithCaption.CaptionHorizontalAlignment =
                        layoutViewItemNode.CaptionHorizontalAlignment ?? modelLayoutElementWithCaption.CaptionHorizontalAlignment;
                }

                if (layoutViewItemNode.CaptionVerticalAlignment is not null)
                {
                    modelLayoutElementWithCaption.CaptionVerticalAlignment =
                        layoutViewItemNode.CaptionVerticalAlignment ?? modelLayoutElementWithCaption.CaptionVerticalAlignment;
                }

                if (layoutViewItemNode.CaptionWordWrap is not null)
                {
                    modelLayoutElementWithCaption.CaptionWordWrap =
                        layoutViewItemNode.CaptionWordWrap ?? modelLayoutElementWithCaption.CaptionWordWrap;
                }
            }

            static void MapModelNode(
                IModelNode genericModelNode,
                LayoutViewItem layoutViewItemNode
            )
            {
                if (layoutViewItemNode.Index is not null)
                {
                    genericModelNode.Index =
                        layoutViewItemNode.Index ?? genericModelNode.Index;
                }
            }

            static void MapSupportControlAlignment(
                ISupportControlAlignment modelSupportControlAlignment,
                LayoutViewItem layoutViewItemNode
            )
            {
                if (layoutViewItemNode.HorizontalAlign is not null)
                {
                    modelSupportControlAlignment.HorizontalAlign =
                        layoutViewItemNode.HorizontalAlign ?? modelSupportControlAlignment.HorizontalAlign;
                }

                if (layoutViewItemNode.VerticalAlign is not null)
                {
                    modelSupportControlAlignment.VerticalAlign =
                        layoutViewItemNode.VerticalAlign ?? modelSupportControlAlignment.VerticalAlign;
                }
            }

            static void MapModelLayoutItem(
                IModelLayoutItem modelLayoutItem,
                LayoutViewItem layoutViewItemNode
            )
            {
                if (layoutViewItemNode.SizeConstraintsType is not null)
                {
                    modelLayoutItem.SizeConstraintsType =
                        layoutViewItemNode.SizeConstraintsType ?? modelLayoutItem.SizeConstraintsType;
                }

                if (layoutViewItemNode.MinSize is not null)
                {
                    modelLayoutItem.MinSize =
                        layoutViewItemNode.MinSize ?? modelLayoutItem.MinSize;
                }

                if (layoutViewItemNode.MaxSize is not null)
                {
                    modelLayoutItem.MaxSize =
                        layoutViewItemNode.MaxSize ?? modelLayoutItem.MaxSize;
                }
            }

            static void MapModelToolTip(
                IModelToolTip modelToolTip,
                LayoutViewItem layoutViewItemNode
            )
            {
                if (layoutViewItemNode.ToolTip is not null)
                {
                    modelToolTip.ToolTip =
                        layoutViewItemNode.ToolTip ?? modelToolTip.ToolTip;
                }
            }

            static void MapModelToolTipOptions(
                IModelToolTipOptions modelToolTipOptions,
                LayoutViewItem layoutViewItemNode
            )
            {
                if (layoutViewItemNode.ToolTipTitle is not null)
                {
                    modelToolTipOptions.ToolTipTitle =
                        layoutViewItemNode.ToolTipTitle ?? modelToolTipOptions.ToolTipTitle;
                }

                if (layoutViewItemNode.ToolTipIconType is not null)
                {
                    modelToolTipOptions.ToolTipIconType =
                        layoutViewItemNode.ToolTipIconType ?? modelToolTipOptions.ToolTipIconType;
                }
            }
        }
    }
}
